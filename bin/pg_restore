#!/bin/bash

set -e

PROGRAM=pg_restore
PATHS=("/usr/lib/postgresql/" "/usr/pgsql-")
PATHSUFIX="/bin/pg_restore"

if [ -x /bin/nice ]; then
    NICE=/bin/nice
else
    NICE=/usr/bin/nice
fi

if [ x"${1}" = x"--flexibee-pg-version" ]; then
    if [ x"${2}" != x ]; then
        VERSION="${2}"
    fi
    shift
    shift

    for PATHPREFIX in "${PATHS[@]}"
    do
        if [ -x $PATHPREFIX$VERSION$PATHSUFIX ]; then
            $NICE $PATHPREFIX$VERSION$PATHSUFIX "$@"
            exit
        fi
    done
fi

CLUSTERARG=""
CLUSTERSUFFIX=""

if [ "${1}"x = "--virtual"x ]; then
    if [ "${2}"x != "default"x ]; then
        CLUSTERSUFFIX=-"${2}"
    fi
    shift
    shift
fi

SUPPORTEDVERSIONS=( "13" "12" "11" "10" )
for ((i=${#SUPPORTEDVERSIONS[@]}-1; i>=0; i--)); # bereme nejstarší dostupnou verzi
do
    ver=${SUPPORTEDVERSIONS[$i]}

    for PATHPREFIX in "${PATHS[@]}"
    do
        if [ -x $PATHPREFIX$ver$PATHSUFIX ]; then
    	        PROGRAM=$PATHPREFIX$ver$PATHSUFIX
    	        break 2;
        fi
    done
done

$NICE $PROGRAM "$@"
